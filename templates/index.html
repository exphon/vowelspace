<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vowel Space Visualizer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ™ï¸</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ™ï¸ Vowel Space Visualizer</h1>
            <p class="subtitle">ëª¨ìŒ ê³µê°„ ë° í¬ë¨¼íŠ¸ ê¶¤ì  ì‹œê°í™” ë„êµ¬</p>
        </header>

        <main>
            <section class="upload-section">
                <h2>íŒŒì¼ ì—…ë¡œë“œ</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="vizType">ì‹œê°í™” ìœ í˜•:</label>
                        <select id="vizType" name="viz_type">
                            <option value="static">ì •ì  ëª¨ìŒ ê³µê°„ (Static Vowel Space)</option>
                            <option value="ellipse">íƒ€ì› ëª¨ìŒ ê³µê°„ (Vowel Space with Ellipses)</option>
                            <option value="dynamic">ë™ì  í¬ë¨¼íŠ¸ ê¶¤ì  (Dynamic Formant Trajectory)</option>
                        </select>
                    </div>

                    <div class="form-group" id="ellipseOptions" style="display: none;">
                        <label>
                            <input type="checkbox" id="showPoints" name="show_points" checked>
                            ê°œë³„ ë°ì´í„° í¬ì¸íŠ¸ í‘œì‹œ
                        </label>
                        <p class="help-text">íƒ€ì›ê³¼ í•¨ê»˜ ì›ë³¸ ë°ì´í„° í¬ì¸íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤</p>
                    </div>

                    <div class="form-group">
                        <label for="fileInput">íŒŒì¼ ì„ íƒ:</label>
                        <input type="file" id="fileInput" name="files" multiple accept=".csv,.txt,.xlsx,.xls,.wav,.TextGrid">
                        <div class="file-info">
                            <p><strong>ì§€ì› í˜•ì‹:</strong></p>
                            <ul>
                                <li><strong>CSV/TXT/XLSX:</strong> F1, F2, vowel ì—´ í¬í•¨ (time, duration ì„ íƒì‚¬í•­)</li>
                                <li><strong>WAV + TextGrid:</strong> ìŒì„± íŒŒì¼ê³¼ ë ˆì´ë¸” íŒŒì¼ (ì„ íƒì‚¬í•­)</li>
                                <li><strong>WAV only:</strong> ìŒì„± íŒŒì¼ë§Œ (ìë™ í¬ë¨¼íŠ¸ ì¶”ì¶œ)</li>
                            </ul>
                            <p class="auto-detect-note">ğŸ’¡ <strong>ìë™ ì»¬ëŸ¼ ê°ì§€:</strong> ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª…ì„ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤ 
                            (ì˜ˆ: f1, F1, first_formant, formant_1 ë“±)</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">
                        <span id="uploadText">ì‹œê°í™”í•˜ê¸°</span>
                        <span id="uploadSpinner" class="spinner" style="display: none;"></span>
                    </button>
                </form>

                <div class="example-section">
                    <button id="exampleBtn" class="btn-secondary">ì˜ˆì œ ë°ì´í„° ë³´ê¸°</button>
                </div>
            </section>

            <section class="result-section" id="resultSection" style="display: none;">
                <h2>ê²°ê³¼</h2>
                
                <div class="data-info" id="dataInfo">
                    <!-- Data summary will be inserted here -->
                </div>

                <div id="plotContainer" class="plot-container">
                    <!-- Plot will be inserted here -->
                </div>

                <div class="action-buttons">
                    <button id="downloadBtn" class="btn-secondary">ê·¸ë˜í”„ ë‹¤ìš´ë¡œë“œ (PNG)</button>
                    <button id="resetBtn" class="btn-secondary">ìƒˆë¡œ ì‹œì‘</button>
                </div>
            </section>

            <section class="error-section" id="errorSection" style="display: none;">
                <div class="error-message" id="errorMessage"></div>
            </section>
        </main>

        <footer>
            <div class="info-section">
                <h3>ì‚¬ìš© ë°©ë²•</h3>
                <ol>
                    <li>ì‹œê°í™” ìœ í˜•ì„ ì„ íƒí•©ë‹ˆë‹¤ (ì •ì /ë™ì )</li>
                    <li>ë°ì´í„° íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤</li>
                    <li>ê²°ê³¼ ê·¸ë˜í”„ë¥¼ í™•ì¸í•˜ê³  ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤</li>
                </ol>
                
                <h3>ë°ì´í„° í˜•ì‹</h3>
                <div class="format-examples">
                    <div class="format-box">
                        <h4>CSV/TXT ì˜ˆì‹œ (ìë™ ê°ì§€ ê°€ëŠ¥)</h4>
                        <pre>vowel,F1,F2,time
i,300,2300,0.5
e,450,2100,1.0
a,700,1200,1.5</pre>
                        <p class="note">ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… ì‚¬ìš© ê°€ëŠ¥: f1/F1/first_formant, phone/vowel/phoneme ë“±</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const vizTypeSelect = document.getElementById('vizType');
        const ellipseOptions = document.getElementById('ellipseOptions');
        const resultSection = document.getElementById('resultSection');
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');
        const dataInfo = document.getElementById('dataInfo');
        const plotContainer = document.getElementById('plotContainer');
        const exampleBtn = document.getElementById('exampleBtn');
        const uploadText = document.getElementById('uploadText');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        let currentPlot = null;

        // Show/hide ellipse options based on visualization type
        vizTypeSelect.addEventListener('change', function() {
            if (this.value === 'ellipse') {
                ellipseOptions.style.display = 'block';
            } else {
                ellipseOptions.style.display = 'none';
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const files = fileInput.files;
            if (files.length === 0) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            formData.append('viz_type', document.getElementById('vizType').value);
            
            // Add ellipse options if ellipse type is selected
            if (document.getElementById('vizType').value === 'ellipse') {
                formData.append('show_ellipses', 'true');
                formData.append('show_points', document.getElementById('showPoints').checked ? 'true' : 'false');
            }

            showLoading(true);
            hideError();
            hideResult();

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult(data);
                } else {
                    showError(data.error || 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                showError('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        exampleBtn.addEventListener('click', async () => {
            showLoading(true);
            hideError();
            hideResult();

            try {
                const response = await fetch('/example');
                const data = await response.json();

                if (response.ok && data.success) {
                    showResult(data);
                } else {
                    showError('ì˜ˆì œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                showError('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (currentPlot) {
                Plotly.downloadImage(plotContainer, {
                    format: 'png',
                    width: 1200,
                    height: 900,
                    filename: 'vowel_space_plot'
                });
            }
        });

        resetBtn.addEventListener('click', () => {
            hideResult();
            hideError();
            uploadForm.reset();
            fileInput.value = '';
        });

        function showResult(data) {
            // Display data summary
            if (data.data_summary) {
                const summary = data.data_summary;
                let summaryHTML = '<h3>ë°ì´í„° ìš”ì•½</h3><ul>';
                summaryHTML += `<li><strong>ì´ ë°ì´í„° í¬ì¸íŠ¸:</strong> ${summary.rows}</li>`;
                
                // ì»¬ëŸ¼ ê°ì§€ ì •ë³´ í‘œì‹œ
                if (summary.column_detection && summary.column_detection.details) {
                    summaryHTML += '<li><strong>ìë™ ê°ì§€ëœ ì»¬ëŸ¼:</strong><ul>';
                    const details = summary.column_detection.details;
                    for (const [standardName, info] of Object.entries(details)) {
                        summaryHTML += `<li><strong>${standardName}</strong>: "${info.actual_name}"`;
                        
                        if (info.min !== undefined) {
                            summaryHTML += ` (ë²”ìœ„: ${Math.round(info.min)}-${Math.round(info.max)} Hz, í‰ê· : ${Math.round(info.mean)} Hz)`;
                        } else if (info.unique_count !== undefined) {
                            summaryHTML += ` (ê³ ìœ ê°’ ${info.unique_count}ê°œ)`;
                            if (info.sample_values && info.sample_values.length > 0) {
                                summaryHTML += ` [ì˜ˆ: ${info.sample_values.join(', ')}]`;
                            }
                        }
                        summaryHTML += '</li>';
                    }
                    summaryHTML += '</ul></li>';
                }
                
                if (summary.vowels && summary.vowels.length > 0) {
                    summaryHTML += `<li><strong>ëª¨ìŒ ì¢…ë¥˜:</strong> ${summary.vowels.join(', ')}</li>`;
                }
                summaryHTML += `<li><strong>ëª¨ë“  ì»¬ëŸ¼:</strong> ${summary.columns.join(', ')}</li>`;
                summaryHTML += '</ul>';
                dataInfo.innerHTML = summaryHTML;
            }

            // Display plot
            currentPlot = data.plot;
            Plotly.newPlot(plotContainer, currentPlot.data, currentPlot.layout, {responsive: true});

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
            errorSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideError() {
            errorSection.style.display = 'none';
        }

        function hideResult() {
            resultSection.style.display = 'none';
        }

        function showLoading(isLoading) {
            if (isLoading) {
                uploadText.style.display = 'none';
                uploadSpinner.style.display = 'inline-block';
                uploadForm.querySelector('button[type="submit"]').disabled = true;
            } else {
                uploadText.style.display = 'inline';
                uploadSpinner.style.display = 'none';
                uploadForm.querySelector('button[type="submit"]').disabled = false;
            }
        }
    </script>
</body>
</html>
